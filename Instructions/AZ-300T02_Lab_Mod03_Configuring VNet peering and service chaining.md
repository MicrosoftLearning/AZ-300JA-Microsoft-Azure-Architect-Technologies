# 仮想ネットワークの作成と管理
# ラボ: VNet ピアリングとサービス チェーンの構成
  
### シナリオ
  
ADatum コーポレーションは、Azure サブスクリプションに Azure仮想ネットワーク間のサービス チェーンを実装したいと考えています。 


### 目的
  
この課題を終了すると、下記ができるようになります。

- Azure Resource Manager テンプレートを使用して、Azure VM をデプロイします。

- VNet ピアリングの構成。

- ルーティングの実装

- サービスチェーンの検証


### ラボの設定
  
予想時間: 45 分

ユーザー名: **student**

パスワード: **Pa55w.rd**



## 演習 1: デプロイ テンプレートを使用した Azure ラボ環境の作成
  
このエクササイズの主なタスクは次のとおりです。

1. Azure Resource Manager テンプレートを使用して、最初のAzure仮想ネットワーク環境を作成します

1. Azure Resource Manager テンプレートを使用して、2 番目のAzure 仮想ネットワーク環境を作成します


#### タスク 1: Azure Resource Manager テンプレートを使用して最初の Azure 仮想ネットワーク環境を作成します
  
1. ラボの仮想マシンから Microsoft Edge を起動し、[**http://portal.azure.com**](http://portal.azure.com) で Azure portalを参照し、ターゲット Azure サブスクリプションの所有者ロールを持つ Microsoft アカウントを使用してサインインします。

1. Azure portal の Microsoft Edge ウィンドウで、**Cloud Shell**内の **Bash**セッションを開始します。 

1. **マウントされたストレージがない**というメッセージが表示された場合は、次の設定を使用してストレージを構成します

    - サブスクリプション： ターゲット Azure サブスクリプションの名前

    - Cloud Shell リージョン： サブスクリプションに使用でき、課題の場所に最も近い Azure リージョンの名前

    - リソース グループ: 新しいリソース グループ **az3000400-LabRG** の名前

    - ストレージ アカウント: 新しいストレージ アカウントの名前

    - ファイル共有: 新しいファイル共有の名前

1. Cloud Shell ペーンから、下記を実行して2つのリソース グループを作成します (`<Azure region>` プレースホルダを、サブスクリプションに使用でき、ラボの場所に最も近い Azure リージョンの名前に置き換えます)。

   ```
   az group create --resource-group az3000401-LabRG --location <Azure region>
   ```

   ```
   az group create --resource-group az3000402-LabRG --location <Azure region>
   ```

1. Cloud Shell ペーンから、最初の Azure Resource Manager テンプレート **\\allfiles\\AZ-300T02\\Module_03\\azuredeploy0401.json** をホーム ディレクトリにアップロードします。

1. Cloud Shell ペインから、パラメータ ファイル **\\allfile\\AZ-300T02\\Module_03\\azuredeploy04.parameters.json** をホーム ディレクトリにアップロードします。

1. Cloud Shell ペインから、下記を実行して、Windows Server 2016 データセンターをホストする Azure VM を最初の仮想ネットワークにデプロイします：

   ```
   az deployment group create --resource-group az3000401-LabRG --template-file azuredeploy0401.json --parameters @azuredeploy04.parameters.json --no-wait
   ```

    > **注**: デプロイが完了するのを待たずに、次のタスクに進みます。


#### タスク 2: Azure Resource Manager テンプレートを使用して2 番目の Azure 仮想ネットワーク環境を作成します

1. Cloud Shell ペーンから、2 番目の Azure Resource Manager テンプレート **\\allfiles\\AZ-300T02\\Module_03\\azuredeploy0402.json** をホーム ディレクトリにアップロードします。

1. Cloud Shell ペーンから、下記を実行して、Windows Server 2016 データセンターをホストする Azure VM を 2 番目の仮想ネットワークにデプロイします。

   ```
   az deployment group create --resource-group az3000402-LabRG --template-file azuredeploy0402.json --parameters @azuredeploy04.parameters.json --no-wait
   ```

    > **注**: 2 番目のテンプレートは、同じパラメーター ファイルを使用します。 

    > **注**: デプロイメントが完了するのを待たず、次のエクササイズに進みます。

> **結果**：このエクササイズを完了したら、Windows Server 2016 データセンターを実行する Azure VM をホストする二つの Azure 仮想ネットワークを作成する必要があります。 


## エクササイズ 2: VNet ピアリングの構成 
  
このエクササイズのタスクは次のとおりです。

1. 両方の仮想ネットワークの VNet ピアリングを構成します

#### タスク 1: 両方の仮想ネットワークの VNet ピアリングを構成します
  
1. Azure portal を表示する Microsoft Edge ウィンドウに、**az3000401-vnet** 仮想ネットワーク ブレードに移動します。

1. **az3000401-vnet**ブレードから、次の設定で VNet ピアリングを作成します。

    - 最初の仮想ネットワークから 二番目の仮想ネットワークへのピアリングの名前: **az3000401-vnet-to-az3000402-vnet**

    - 仮想ネットワーク デプロイメント モデル: **Resource Manager**

    - サブスクリプション: このラボのために使用するAzureサブスクリプションの名前

    - 仮想ネットワーク: **az3000402-vnet**
    
    - 最初の仮想ネットワークから 2 番目の仮想ネットワークへのピアリングの名前: **az3000402-vnet-to-az3000401-vnet**    
    
    - 最初の仮想ネットワークから二番目の仮想ネットワークへの仮想ネットワーク アクセスを許可します。**有効**
    
    - 2 番目の仮想ネットワークから最初の仮想ネットワークへの仮想ネットワーク アクセスを許可します。**有効**    

    - 最初の仮想ネットワークから 2 番目の仮想ネットワークへの転送トラフィックを許可します。**無効**
    
    - 2 番目の仮想ネットワークから最初の仮想ネットワークへの転送トラフィックを許可します。**無効**

    - ゲートウェイトランジットの許可: 無効

## エクササイズ3：ルーティングの実装
  
このエクササイズの主なタスクは次のとおりです。

1. IP 転送を有効にします

1. ユーザー定義ルーティングの構成 

1. Windows Server 2016 を実行している Azure VM にルーティングを構成します


#### タスク 1: IP 転送の有効化 
  
1. **az3000401-LabRG** の概要ページで **az3000401-nic2** ブレード (**az3000401-vm2** の NIC)に移動します。

1. **az3000401-nic2** ブレードの **IP 構成** に移動し、**IP 転送**を **有効**に設定してを保存します。


#### タスク 2: ユーザー定義ルーティングの構成 

1. Azure portalから、次の設定で新しいルート テーブルを作成します:

    - サブスクリプション: このラボに使用する Azure サブスクリプションの名前

    - リソース グループ: **az3000402-LabRG**

    - リージョン: 仮想ネットワークを作成したのと同じ Azure リージョン
  
    - 名前: **az3000402-rt1**

    - ゲートウェイ ルートを伝達する：**No**
    
    ルートテーブルの作成が完了したら、「**リソースに移動**」 をクリックします。

1. Azure portal で、前の手順で作成したルート テーブル az3000402-rt1 で、「**設定**」 の下の 「**ルート**」 をクリックし、次の設定でルートを追加します。 

    - ルート名: **custom-route-to-az3000401-vnet**

    - アドレス プレフィックス: **10.0.0.0/22**

    - 次のホップの種類: **仮想アプライアンス**

    - 次のホップのアドレス: **10.0.1.4**

1. **サブネット** ブレードから **az3000402-vnet** の **subnet-1** にルート テーブルを関連付けます。


#### タスク 3: Windows Server 2016 を実行している Azure VM にルーティングを構成します

1. **az3000401-LabRG** リソースグループの **az3000401-vm2** にリモート デスクトップ セッションで接続します。 

1. 認証を求める場合は、次の資格情報を指定します。

    - ユーザー名: **student**

    - パスワード: **Pa55w.rd1234**

1. リモート デスクトップ セッションで az3000401-vm2 に接続したら、**リモート アクセス** ロールをインストールします。サーバー マネージャーで、「**Manage**」 をクリックし、**役割と機能の追加(Add Roles and Features)** をクリックします。

1. 「開始する前に(Before you begin)」画面で、「**次へ(Next)**」 をクリックします。

1. インストールの種類画面で、既定の **ロール ベースまたは機能ベースのインストール(Role-based or feature-based installation)** を選択したままにして、**次へ(Next)** をクリックします。

1. サーバーの選択画面で、既定のサーバーを選択したままにし、**次へ(Next)** をクリックします

1. サーバーのロール画面で、**リモート アクセス(Remote Access)** の横にチェックマークを付けて、**次へ(Next)** をクリックします。

1. 機能画面で、既定値を選択したままにして、 **次へ(Next)** をクリックします。

1. リモート アクセス(Remote Access)画面で、**次へ(Next)** をクリックします。

1. サービス画面で、**ルーティング(Routing)** の横にチェックマークを付けて、**Add Features** をクリック後 **次へ(Next)** をクリックします。

1. Web Server Role(IIS) 画面で **Next** をクリックします。

1. Select role services 画面で **Next** をクリックします。

1. Confirm installation selections 画面で、**インストール(Install)** をクリックします。

1. インストールが完了したら **Close** をクリックして閉じます。

1. az3000401-vm2 へのリモート デスクトップ セッションで、サーバー マネージャーから 「**ツール**」 をクリックし、「**ルーティングとリモート アクセス**」 をクリックして RRAS コンソールを開きます。 

1. **ルーティングとリモート アクセス** コンソールで、サーバー az3000401-vm2 の名前の下で右クリックし、「**ルーティングとリモートアクセスの構成と有効化**」 を選択して、**ルーティングとリモート アクセス サーバー セットアップ ウィザード**を実行します。

1. **Next** をクリックします。

1. **ルーティングとリモート アクセス サーバーのセットアップ ウィザード**では、**Configuration** の下で **Custom Configuration** を選択し、**Next** をクリックします。

1. **LAN ルーティング**をチェックして **Next** をクリックします。 

1. **Finish** をクリックします。

> **注**: 警告ポップアップが表示された場合は、「**OK**」 をクリックします。

1. **Start service** をクリックして「**ルーティングとリモート アクセス**」 サービスを開始します。

1. az3000401-vm2 へのリモート デスクトップ セッションで、「スタート」ボタン(Windowsマーク)をクリックし、「**Windows Administrative Tools**」 をクリックします。

1. 管理ツールから、**Windows Firewall with Advanced Security(セキュリティが強化された Windows ファイアウォール)** コンソールを起動します。

1. コンソールで、**Inbound Rules(受信規則)** をクリックします。

1. 「**ファイルとプリンターの共有 (エコー要求 - ICMPv4-In)**」 の受信規則を見つけ、その規則を右クリックして 「**ルールを有効にする**」 をクリックします。

> **結果**: この演習の完了後に、2 番目の仮想ネットワーク内にカスタム ルーティングが構成されます。


## 演習 4: サービス チェーンの検証
  
このエクササイズの主なタスクは次のとおりです。

1. Azure VM に高度なセキュリティを使用して Windows ファイアウォールを構成します。

1. ピアリングされた仮想ネットワーク間のサービス チェーンのテストします


#### タスク 1: ターゲット Azure VM に高度なセキュリティを使用して Windows ファイアウォールを構成します。
  
1. **az3000401-vm1** でリモート デスクトップ セッションを開始します。 

1. 認証を求める場合は、次の資格情報を指定します。

    - ユーザー名: **student**

    - パスワード: **Pa55w.rd1234**

1. 管理ツールから、**Windows Firewall with Advanced Security(セキュリティが強化された Windows ファイアウォール)** コンソールを起動します。

1. コンソールで、**Inbound Rules(受信規則)** をクリックします。

1. 「**ファイルとプリンターの共有 (エコー要求 - ICMPv4-In)**」 の受信規則を見つけ、その規則を右クリックして 「**ルールを有効にする**」 をクリックします。

#### タスク 2: ピアリングされた仮想ネットワーク間のサービス チェーンをテストする
  
1. **az3000402-vm1** でリモート デスクトップ セッションを開始します。 

1. 認証を求める場合は、次の資格情報を指定します。

    - ユーザー名: **student**

    - パスワード: **Pa55w.rd1234**

1. **Windows PowerShell** を起動します。

1. **Windows PowerShell** ウィンドウで、次のコマンドを実行します。

   ```pwsh
   Test-NetConnection -ComputerName 10.0.0.4 -TraceRoute
   ```

1. テストの成功を確認し、接続が 10.0.1.4 を超えてルーティングされたことを確認します。

>  **結果**: このエクササイズを完了したら、ピアリングされた仮想ネットワーク間のサービス チェーンを検証する必要があります。

## 演習 5: ラボ リソースを削除する

#### タスク 1: Cloud Shell を開く

1. ポータルの上部にある 「**Cloud Shell**」 アイコンをクリックして、Cloud Shell ペインを開きます。

1. 必要に応じて、Cloud Shell ペインの左上隅にあるドロップ ダウン リストを使用して、Bash シェル セッションに切り替えます。

1. **「Cloud Shell」** コマンドプロンプトで、次のコマンドを入力し、**「Enter」** キーを押して、このラボで作成したすべてのリソース グループを一覧表示します。

   ```
   az group list --query "[?starts_with(name,'az30004')]".name --output tsv
   ```

1. このラボで作成したリソース グループのみが出力に含まれていることを確認します。これらのグループは、次のタスクで削除されます。

#### タスク 2: リソース グループを削除する 

1. 「**Cloud Shell**」 コマンド プロンプトで、次のコマンドを入力し、**Enter** キーを押して、このラボで作成したリソース グループを削除します

   ```sh
   az group list --query "[?starts_with(name,'az30004')]".name --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
   ```

1. ポータルの下部にある 「**Cloud Shell**」 プロンプトを閉じます。

> **結果**: このエクササイズでは、このラボで使用するリソースを削除しました。
